services:
  app:
    build: .
    volumes:
      - ./my-files:/app/my-files
    depends_on:
      ollama:
        condition: service_healthy

  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    build:
      dockerfile: Dockerfile.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=-1
    healthcheck:
      # CHANGE 1: Check for the marker file instead of running a command
      test: ["CMD-SHELL", "[ -f /tmp/ollama_ready ] || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 5s
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        /bin/ollama serve &
        pid=$$!
        
        # Wait for Ollama to be ready
        sleep 5
        
        # Pull the model
        ollama pull gemma3:1b

        # Preload the model
        ollama run gemma3:1b "hello" > /dev/null 2>&1 || echo "Model pre-load initiated"

        echo "Ollama ready with gemma3:1b loaded"
        
        # CHANGE 2: Create the marker file to signal the Healthcheck
        touch /tmp/ollama_ready
        
        # Wait for the background process
        wait $$pid

        
volumes:
  my-files:
  ollama-data: